<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Lingkungan Kita</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="admin-body">
    <!-- Header -->
    <header>
        <div class="logo">
            <span class="logo-icon">ðŸŒ±</span>
            <span>LingkunganKita - Admin</span>
        </div>
        <div class="nav-buttons">
            <span class="admin-welcome">
                <i class="fas fa-user-circle"></i>
                <span id="adminUsername">Loading...</span>
            </span>
            <a href="index.html" class="btn btn-outline">
                <i class="fas fa-home"></i>
                <span class="text">Halaman Utama</span>
            </a>
            <button class="btn btn-primary" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span class="text">Keluar</span>
            </button>
        </div>
    </header>

    <!-- Loading Screen -->
    <div id="loadingScreen" style="display: flex; justify-content: center; align-items: center; height: 50vh;">
        <div style="text-align: center;">
            <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary); margin-bottom: 1rem;"></i>
            <p>Memuat panel admin...</p>
        </div>
    </div>

    <!-- Admin Panel (hidden initially) -->
    <div class="admin-panel" id="adminPanel" style="display: none;">
        <div class="admin-header">
            <h1><i class="fas fa-cog"></i> Panel Administrator</h1>
            <div class="admin-actions">
                <button class="btn btn-success" id="exportData">
                    <i class="fas fa-download"></i>
                    <span class="text">Ekspor Data</span>
                </button>
                <button class="btn btn-primary" id="refreshData">
                    <i class="fas fa-sync-alt"></i>
                    <span class="text">Refresh</span>
                </button>
            </div>
        </div>
        
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="issues">
                <i class="fas fa-list"></i>
                <span>Kelola Laporan</span>
                <span class="badge" id="issuesCount">0</span>
            </button>
            <button class="admin-tab" data-tab="analytics">
                <i class="fas fa-chart-line"></i>
                <span>Analitik</span>
            </button>
            <button class="admin-tab" data-tab="settings">
                <i class="fas fa-sliders-h"></i>
                <span>Pengaturan</span>
            </button>
        </div>
        
        <div class="admin-content">
            <!-- Issues Management Tab -->
            <div id="issues-tab" class="admin-tab-content">
                <div class="tab-header">
                    <h2><i class="fas fa-list"></i> Kelola Laporan Isu Lingkungan</h2>
                    <div class="tab-actions">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Cari laporan..." id="searchIssues">
                        </div>
                        <select id="statusFilter" class="form-control">
                            <option value="">Semua Status</option>
                            <option value="new">Baru</option>
                            <option value="in-progress">Diproses</option>
                            <option value="completed">Selesai</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="issues-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Jenis Isu</th>
                                <th>Lokasi</th>
                                <th>Status</th>
                                <th>Tanggal</th>
                                <th>Pelapor</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="issuesTableBody">
                            <tr>
                                <td colspan="7" class="loading">Memuat data laporan...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-footer">
                    <div class="table-info" id="tableInfo">
                        Menampilkan 0 laporan
                    </div>
                    <div class="pagination">
                        <button class="btn btn-outline btn-sm" id="prevPage" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="page-info" style="padding: 0.5rem;">Halaman 1</span>
                        <button class="btn btn-outline btn-sm" id="nextPage">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics-tab" class="admin-tab-content" style="display: none;">
                <div class="tab-header">
                    <h2><i class="fas fa-chart-line"></i> Analitik Laporan</h2>
                    <div class="date-filter">
                        <select class="form-control" id="analyticsPeriod">
                            <option value="7">7 Hari Terakhir</option>
                            <option value="30" selected>30 Hari Terakhir</option>
                            <option value="90">3 Bulan Terakhir</option>
                        </select>
                    </div>
                </div>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h3>Ringkasan Laporan</h3>
                        </div>
                        <div class="analytics-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="totalReports">0</div>
                                <div class="stat-label">Total Laporan</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="avgResolution">0 hr</div>
                                <div class="stat-label">Rata-rata Waktu</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="completionRate">0%</div>
                                <div class="stat-label">Tingkat Penyelesaian</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h3>Distribusi Jenis Isu</h3>
                        </div>
                        <div class="chart-placeholder">
                            <div class="chart-dummy">
                                <div class="chart-bar" style="height: 80%; background: var(--primary);" data-label="Sampah" data-count="0"></div>
                                <div class="chart-bar" style="height: 60%; background: var(--secondary);" data-label="Air" data-count="0"></div>
                                <div class="chart-bar" style="height: 40%; background: var(--accent);" data-label="Fasilitas" data-count="0"></div>
                                <div class="chart-bar" style="height: 20%; background: var(--success);" data-label="Lainnya" data-count="0"></div>
                            </div>
                            <div class="chart-labels"></div>
                        </div>
                    </div>
                    
                    <div class="analytics-card full-width">
                        <div class="analytics-header">
                            <h3>Trend Laporan Bulanan</h3>
                        </div>
                        <div class="trend-placeholder">
                            <div class="trend-stats">
                                <div class="trend-item">
                                    <div class="trend-value" id="monthlyReports">0</div>
                                    <div class="trend-label">Laporan Bulan Ini</div>
                                </div>
                                <div class="trend-item">
                                    <div class="trend-value" id="resolvedThisMonth">0</div>
                                    <div class="trend-label">Diselesaikan</div>
                                </div>
                                <div class="trend-item">
                                    <div class="trend-value" id="resolutionRate">0%</div>
                                    <div class="trend-label">Tingkat Resolusi</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
           <!-- Settings Tab -->
<div id="settings-tab" class="admin-tab-content" style="display: none;">
    <div class="tab-header">
        <h2><i class="fas fa-sliders-h"></i> Pengaturan Sistem</h2>
    </div>
    
    <div class="settings-grid">
        <div class="settings-card">
            <h3><i class="fas fa-bell"></i> Notifikasi</h3>
            <div class="setting-item">
                <label>Email Notifikasi</label>
                <input type="email" class="form-control" value="admin@lingkungankita.id">
            </div>
            <div class="setting-item">
                <label class="toggle-label">
                    <span>Notifikasi Laporan Baru</span>
                    <input type="checkbox" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label class="toggle-label">
                    <span>Notifikasi Email Otomatis</span>
                    <input type="checkbox">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        
        <div class="settings-card">
            <h3><i class="fas fa-map-marker-alt"></i> Wilayah Kecamatan</h3>
            <div class="setting-item">
                <label>Kecamatan Default</label>
                <select class="form-control" id="defaultKecamatan">
                    <option value="">Pilih Kecamatan</option>
                    <option value="Ujung Bulu">Ujung Bulu</option>
                    <option value="Ujung Loe">Ujung Loe</option>
                    <option value="Gantorang">Gantorang</option>
                    <option value="Kindang">Kindang</option>
                    <option value="Bonto Bahari">Bonto Bahari</option>
                    <option value="Bontotiro">Bontotiro</option>
                    <option value="Hero Lange-Lange">Hero Lange-Lange</option>
                    <option value="Kajang">Kajang</option>
                    <option value="Bulukumpa">Bulukumpa</option>
                    <option value="Rilau Ale">Rilau Ale</option>
                </select>
            </div>
            <div class="setting-item">
                <label>Filter Berdasarkan Kecamatan</label>
                <select class="form-control" id="filterKecamatan" multiple style="height: 120px;">
                    <option value="Ujung Bulu" selected>Ujung Bulu</option>
                    <option value="Ujung Loe" selected>Ujung Loe</option>
                    <option value="Gantorang" selected>Gantorang</option>
                    <option value="Kindang" selected>Kindang</option>
                    <option value="Bonto Bahari" selected>Bonto Bahari</option>
                    <option value="Bontotiro" selected>Bontotiro</option>
                    <option value="Hero Lange-Lange" selected>Hero Lange-Lange</option>
                    <option value="Kajang" selected>Kajang</option>
                    <option value="Bulukumpa" selected>Bulukumpa</option>
                    <option value="Rilau Ale" selected>Rilau Ale</option>
                </select>
                <small style="color: var(--gray); font-size: 0.8rem;">Tahan Ctrl untuk memilih multiple kecamatan</small>
            </div>
        </div>
        
        <div class="settings-card">
            <h3><i class="fas fa-shield-alt"></i> Keamanan</h3>
            <div class="setting-item">
                <button class="btn btn-outline" id="changePassword">
                    <i class="fas fa-key"></i>
                    Ganti Password
                </button>
            </div>
            <div class="setting-item">
                <label class="toggle-label">
                    <span>Two-Factor Authentication</span>
                    <input type="checkbox">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label>Session Timeout</label>
                <select class="form-control">
                    <option value="30">30 menit</option>
                    <option value="60" selected>1 jam</option>
                    <option value="120">2 jam</option>
                    <option value="240">4 jam</option>
                </select>
            </div>
        </div>

        <div class="settings-card">
            <h3><i class="fas fa-chart-bar"></i> Statistik Wilayah</h3>
            <div class="setting-item">
                <div id="kecamatanStats">
                    <div class="stat-item-small">
                        <span class="stat-label-small">Total Kecamatan:</span>
                        <span class="stat-value-small">10</span>
                    </div>
                    <div class="stat-item-small">
                        <span class="stat-label-small">Kecamatan Aktif:</span>
                        <span class="stat-value-small">10</span>
                    </div>
                    <div class="stat-item-small">
                        <span class="stat-label-small">Laporan Hari Ini:</span>
                        <span class="stat-value-small">0</span>
                    </div>
                </div>
            </div>
            <div class="setting-item">
                <button class="btn btn-outline btn-sm" onclick="updateKecamatanStats()">
                    <i class="fas fa-sync-alt"></i>
                    Update Statistik
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <script>
        // Auth state management
        firebase.auth().onAuthStateChanged((user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const adminPanel = document.getElementById('adminPanel');
            
            if (user) {
                // User is signed in
                console.log('Admin user:', user.email);
                document.getElementById('adminUsername').textContent = user.email;
                
                // Show admin panel
                loadingScreen.style.display = 'none';
                adminPanel.style.display = 'block';
                
                // Load admin data
                loadAdminIssues();
                
            } else {
                // User is signed out, redirect to login
                console.log('No user, redirecting to login');
                window.location.href = 'admin-login.html';
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                firebase.auth().signOut().then(() => {
                    console.log('User signed out');
                    window.location.href = 'admin-login.html';
                }).catch((error) => {
                    console.error('Sign out error:', error);
                });
            }
        });

        // Basic admin functions (sementara)
        async function loadAdminIssues() {
            try {
                const tableBody = document.getElementById('issuesTableBody');
                
                // Coba ambil data dari Firestore
                const querySnapshot = await db.collection('issues').get();
                
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="no-data">Belum ada laporan</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = '';
                let count = 0;
                
                querySnapshot.forEach((doc) => {
                    count++;
                    const issue = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${doc.id}</td>
                        <td>${issue.type || 'Tidak diketahui'}</td>
                        <td>${issue.location || 'Tidak ada lokasi'}</td>
                        <td><span class="issue-status status-${issue.status || 'new'}">${issue.status || 'Baru'}</span></td>
                        <td>${issue.createdAt ? new Date(issue.createdAt.seconds * 1000).toLocaleDateString('id-ID') : 'Tidak diketahui'}</td>
                        <td>${issue.reporterEmail || 'Tidak ada email'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewIssue('${doc.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-success btn-sm" onclick="updateIssueStatus('${doc.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteIssue('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('issuesCount').textContent = count;
                document.getElementById('tableInfo').textContent = `Menampilkan ${count} laporan`;
                
            } catch (error) {
                console.error('Error loading issues:', error);
                const tableBody = document.getElementById('issuesTableBody');
                tableBody.innerHTML = '<tr><td colspan="7" class="error">Gagal memuat data. Periksa koneksi internet dan konfigurasi Firebase.</td></tr>';
            }
        }

        // Basic admin functions
        function viewIssue(issueId) {
            alert(`Melihat detail laporan: ${issueId}`);
        }

        function updateIssueStatus(issueId) {
            alert(`Mengupdate status laporan: ${issueId}`);
        }

        function deleteIssue(issueId) {
            if (confirm(`Hapus laporan ${issueId}?`)) {
                alert(`Menghapus laporan: ${issueId}`);
            }
        }

        // Tab functionality
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.admin-tab-content').forEach(c => c.style.display = 'none');

                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).style.display = 'block';
            });
        });

        // Enhanced Refresh Function
document.getElementById('refreshData').addEventListener('click', async function() {
    const refreshBtn = this;
    const originalHTML = refreshBtn.innerHTML;
    
    // Show loading state
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...';
    refreshBtn.disabled = true;
    
    try {
        console.log('ðŸ”„ Refreshing data...');
        
        // Reload issues
        await loadAdminIssues();
        
        // Reload analytics if on analytics tab
        const activeTab = document.querySelector('.admin-tab.active');
        if (activeTab && activeTab.getAttribute('data-tab') === 'analytics') {
            await loadAnalytics();
        }
        
        // Show success message
        showAdminMessage('Data berhasil diperbarui!', 'success');
        
    } catch (error) {
        console.error('Refresh error:', error);
        showAdminMessage('Gagal memuat data: ' + error.message, 'error');
    } finally {
        // Restore button state
        refreshBtn.innerHTML = originalHTML;
        refreshBtn.disabled = false;
    }
});

// Responsive Helper Functions
function checkScreenSize() {
    const width = window.innerWidth;
    const adminPanel = document.getElementById('adminPanel');
    
    if (width < 768) {
        document.body.classList.add('mobile-view');
        document.body.classList.remove('tablet-view', 'desktop-view');
    } else if (width < 1024) {
        document.body.classList.add('tablet-view');
        document.body.classList.remove('mobile-view', 'desktop-view');
    } else {
        document.body.classList.add('desktop-view');
        document.body.classList.remove('mobile-view', 'tablet-view');
    }
}

// Initialize responsive behavior
document.addEventListener('DOMContentLoaded', function() {
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
    
    // Add touch support for mobile
    if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
    }
});

// Enhanced table scrolling for mobile
function initTableScroll() {
    const tableContainer = document.querySelector('.table-container');
    if (tableContainer && 'ontouchstart' in window) {
        let startX;
        let scrollLeft;
        
        tableContainer.addEventListener('touchstart', (e) => {
            startX = e.touches[0].pageX - tableContainer.offsetLeft;
            scrollLeft = tableContainer.scrollLeft;
        });
        
        tableContainer.addEventListener('touchmove', (e) => {
            if (!startX) return;
            const x = e.touches[0].pageX - tableContainer.offsetLeft;
            const walk = (x - startX) * 2;
            tableContainer.scrollLeft = scrollLeft - walk;
        });
    }
}

// Call this after loading table data
initTableScroll();

// Enhanced Tab Switching
document.querySelectorAll('.admin-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        // Remove active class from all tabs
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        // Add active class to clicked tab
        this.classList.add('active');
        
        // Show corresponding content
        const tabId = this.getAttribute('data-tab');
        document.querySelectorAll('.admin-tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        const targetTab = document.getElementById(tabId + '-tab');
        if (targetTab) {
            targetTab.style.display = 'block';
            
            // Load specific data based on tab
            if (tabId === 'analytics') {
                loadAnalytics();
            } else if (tabId === 'issues') {
                loadAdminIssues();
            }
        }
    });
});

// Enhanced Export Function
document.getElementById('exportData').addEventListener('click', async function() {
    const exportBtn = this;
    const originalHTML = exportBtn.innerHTML;
    
    // Show loading state
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyiapkan...';
    exportBtn.disabled = true;
    
    try {
        console.log('ðŸ“Š Preparing data export...');
        
        // Get all issues
        const querySnapshot = await db.collection('issues')
            .orderBy('createdAt', 'desc')
            .get();
        
        if (querySnapshot.empty) {
            showAdminMessage('Tidak ada data untuk diekspor', 'warning');
            return;
        }
        
        // Prepare CSV content
        let csvContent = "ID,Jenis Isu,Lokasi,Status,Email Pelapor,Telepon,Tanggal Dibuat,Terakhir Update,Jumlah Foto,Deskripsi\n";
        
        querySnapshot.forEach(doc => {
            const data = doc.data();
            
            // Format dates
            const createdAt = data.createdAt ? 
                data.createdAt.toDate().toLocaleString('id-ID') : 'Tidak diketahui';
            const updatedAt = data.updatedAt ? 
                data.updatedAt.toDate().toLocaleString('id-ID') : 'Tidak pernah';
            
            // Escape CSV special characters
            const escapeCSV = (str) => {
                if (!str) return '';
                return `"${String(str).replace(/"/g, '""')}"`;
            };
            
            csvContent += [
                escapeCSV(doc.id),
                escapeCSV(getIssueTypeLabel(data.type)),
                escapeCSV(data.location),
                escapeCSV(getStatusLabel(data.status)),
                escapeCSV(data.reporterEmail),
                escapeCSV(data.reporterPhone),
                escapeCSV(createdAt),
                escapeCSV(updatedAt),
                escapeCSV(data.photoCount || 0),
                escapeCSV(data.description)
            ].join(',') + '\n';
        });
        
        // Create and download CSV file
        const blob = new Blob(['\uFEFF' + csvContent], { 
            type: 'text/csv;charset=utf-8;' 
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().split('T')[0];
        
        link.href = url;
        link.download = `laporan-lingkungan-${timestamp}.csv`;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showAdminMessage(`Data berhasil diekspor (${querySnapshot.size} laporan)`, 'success');
        
    } catch (error) {
        console.error('Export error:', error);
        showAdminMessage('Gagal mengekspor data: ' + error.message, 'error');
    } finally {
        // Restore button state
        exportBtn.innerHTML = originalHTML;
        exportBtn.disabled = false;
    }
});
    </script>
    <!-- Tambahkan sebelum </body> di admin.html -->
<div class="modal" id="adminModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="modalTitle">Detail Laporan</h2>
            <button class="close-modal" onclick="closeAdminModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Content akan diisi oleh JavaScript -->
        </div>
    </div>
</div>

<script>
    // Enhanced animations and interactions
document.addEventListener('DOMContentLoaded', function() {
    // Add loading animation
    const cards = document.querySelectorAll('.analytics-card, .settings-card, .table-container');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });
    
    // Enhanced table row animations
    const tableRows = document.querySelectorAll('.issues-table tbody tr');
    tableRows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.05}s`;
        row.classList.add('fade-in');
    });
    
    // Floating action button functionality
    const fab = document.getElementById('mobileMenuBtn');
    if (fab) {
        fab.addEventListener('click', function() {
            // Scroll to top or show quick actions
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
    
    // Add parallax effect to admin header
    window.addEventListener('scroll', function() {
        const scrolled = window.pageYOffset;
        const parallax = document.querySelector('.admin-header');
        if (parallax) {
            parallax.style.transform = `translateY(${scrolled * 0.5}px)`;
        }
    });
});

// Add CSS for fade-in animation
const style = document.createElement('style');
style.textContent = `
    .fade-in {
        animation: fadeInUp 0.5s ease-out both;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Hover effects for cards */
    .analytics-card:hover .stat-value,
    .settings-card:hover h3 {
        transform: scale(1.05);
        transition: transform 0.3s ease;
    }
    
    /* Pulse animation for notifications */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .badge {
        animation: pulse 2s infinite;
    }
`;
document.head.appendChild(style);
    // Enhanced Admin Functions
    async function viewIssue(issueId) {
        try {
            const doc = await db.collection('issues').doc(issueId).get();
            if (doc.exists) {
                const data = doc.data();
                
                // Format modal content
                const modalContent = `
                    <div class="issue-detail-modal">
                        <div class="detail-section">
                            <h3>Informasi Laporan</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>ID Laporan:</label>
                                    <span>${issueId}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Jenis Isu:</label>
                                    <span>${getIssueTypeLabel(data.type)}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Status:</label>
                                    <span class="status-badge status-${data.status}">${getStatusLabel(data.status)}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Lokasi:</label>
                                    <span>${data.location || 'Tidak ada lokasi'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Email Pelapor:</label>
                                    <span>${data.reporterEmail || 'Tidak ada email'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Telepon:</label>
                                    <span>${data.reporterPhone || 'Tidak ada telepon'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Tanggal Dibuat:</label>
                                    <span>${data.createdAt ? data.createdAt.toDate().toLocaleString('id-ID') : 'Tidak diketahui'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Terakhir Diupdate:</label>
                                    <span>${data.updatedAt ? data.updatedAt.toDate().toLocaleString('id-ID') : 'Tidak pernah'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h3>Deskripsi</h3>
                            <div class="description-box">
                                ${data.description || 'Tidak ada deskripsi'}
                            </div>
                        </div>
                        
                        ${data.photoBase64 && data.photoBase64.length > 0 ? `
                        <div class="detail-section">
                            <h3>Foto Bukti (${data.photoBase64.length})</h3>
                            <div class="photo-gallery-admin">
                                ${data.photoBase64.map((photo, index) => `
                                    <div class="admin-photo-item">
                                        <img src="${photo}" alt="Foto bukti ${index + 1}" onclick="openAdminPhotoModal('${photo}')">
                                        <span class="photo-number">${index + 1}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="modal-actions">
                            <button class="btn btn-primary" onclick="closeAdminModal()">Tutup</button>
                            <button class="btn btn-success" onclick="updateIssueStatus('${issueId}')">Update Status</button>
                        </div>
                    </div>
                `;
                
                // Show modal
                document.getElementById('modalTitle').textContent = 'Detail Laporan';
                document.getElementById('modalBody').innerHTML = modalContent;
                document.getElementById('adminModal').style.display = 'flex';
                
            } else {
                alert('Laporan tidak ditemukan!');
            }
        } catch (error) {
            console.error('Error viewing issue:', error);
            alert('Error: ' + error.message);
        }
    }

    async function updateIssueStatus(issueId) {
        try {
            const doc = await db.collection('issues').doc(issueId).get();
            if (!doc.exists) {
                alert('Laporan tidak ditemukan!');
                return;
            }
            
            const currentStatus = doc.data().status || 'new';
            const newStatus = prompt(
                'Update Status Laporan:\n\n' +
                'new - Baru\n' +
                'in-progress - Sedang Diproses\n' +
                'completed - Selesai\n\n' +
                'Status saat ini: ' + getStatusLabel(currentStatus),
                currentStatus
            );
            
            if (newStatus && ['new', 'in-progress', 'completed'].includes(newStatus)) {
                await db.collection('issues').doc(issueId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showAdminMessage('Status berhasil diupdate!', 'success');
                loadAdminIssues();
                closeAdminModal();
                
            } else if (newStatus) {
                alert('Status tidak valid! Gunakan: new, in-progress, atau completed');
            }
            
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Error: ' + error.message);
        }
    }

    async function deleteIssue(issueId) {
        if (confirm(`Yakin ingin menghapus laporan ${issueId}?\n\nTindakan ini tidak dapat dibatalkan!`)) {
            try {
                await db.collection('issues').doc(issueId).delete();
                showAdminMessage('Laporan berhasil dihapus!', 'success');
                loadAdminIssues();
            } catch (error) {
                console.error('Error deleting issue:', error);
                alert('Error: ' + error.message);
            }
        }
    }

    function closeAdminModal() {
        document.getElementById('adminModal').style.display = 'none';
    }

    function openAdminPhotoModal(photoBase64) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            cursor: pointer;
        `;
        
        modal.innerHTML = `
            <div style="position: relative; max-width: 95%; max-height: 95%;">
                <img src="${photoBase64}" style="max-width: 100%; max-height: 95vh; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="position: absolute; top: -50px; right: 0; background: var(--danger); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">
                    Ã—
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // Helper functions
    function getIssueTypeLabel(type) {
        const types = {
            'trash': 'Sampah Liar',
            'water': 'Polusi Air', 
            'facility': 'Kerusakan Fasilitas',
            'tree': 'Pohon Tumbang'
        };
        return types[type] || type || 'Tidak Diketahui';
    }

    function getStatusLabel(status) {
        const statuses = {
            'new': 'Baru',
            'in-progress': 'Sedang Diproses',
            'completed': 'Selesai'
        };
        return statuses[status] || status || 'Tidak Diketahui';
    }

    function showAdminMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem;
            border-radius: 8px;
            color: white;
            z-index: 10000;
            max-width: 300px;
            box-shadow: var(--shadow-lg);
        `;
        
        const bgColors = {
            'success': 'var(--success)',
            'error': 'var(--danger)', 
            'warning': 'var(--warning)',
            'info': 'var(--primary)'
        };
        
        messageDiv.style.backgroundColor = bgColors[type] || bgColors.info;
        messageDiv.innerHTML = `<div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
            <span>${message}</span>
        </div>`;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 4000);
    }

    // Make functions global
    window.viewIssue = viewIssue;
    window.updateIssueStatus = updateIssueStatus;
    window.deleteIssue = deleteIssue;
    window.closeAdminModal = closeAdminModal;
    window.openAdminPhotoModal = openAdminPhotoModal;
</script>
<!-- Floating Action Button for Mobile -->
<button class="floating-action-btn" id="mobileMenuBtn" title="Menu Utama">
    <i class="fas fa-bars"></i>
</button>
</body>
</html>